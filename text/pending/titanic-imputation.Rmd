---
title: Illustrating imputation of missing data using the Titanic dataset
source: "New"
author: Steve Simon
date: 2024-05-07
categories:
- Blog post
tags:
- Missing data
- R programming
output: html_document
---

Splines provide a useful way to model relationships that are more complex than a simple linear relationship. They work in a variety of regression models. Here is an illustration of how to use a spline in a logistic regression model with data from survival of passengers on the Titanic.

<!---more--->

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(mice)
library(readr)
library(rms)
library(tidyverse)
library(yaml)
f0 <- "https://raw.githubusercontent.com/pmean/datasets/master/"
f1 <- "titanic-data-dictionary.yaml"
dd <- read_yaml(paste0(f0, f1))
```

The Titanic was a large cruise ship, the biggest of its kind in 1912. It was thought to be unsinkable, but when it set sail from England to American in its maiden voyage, it struck an iceberg and sank, killing many of the passengers and crew. You can get fairly good data on the characteristics of passengers who died and compare them to those that survived. The data indicate a strong effect due to age and gender, representing a philosophy of "women and children first" that held during the boarding of life boats. Let's look at the effect of age on survival using a logistic regression model.

Here is a brief description of this dataset, taken from the [data dictionary][sim3] on my github site.

`r dd$description`

[sim3]: https://raw.githubusercontent.com/pmean/datasets/master/titanic-data-dictionary.yaml

Here are the first few rows of data.

```{r}
f2 <- "titanic_v00.txt"
ti0 <- 
  data.frame(
    read_tsv(
      file=paste0(f0, f2),
      col_types="ccncn"))
names(ti0) <- tolower(names(ti0))
head(ti0)
```

Here are a few descriptive statistics

```{r}
summary(ti0$age)
count(ti0, pclass)
count(ti0, sex)
count(ti0, survived)
```

Notice the large number of missing values for age. The first three passegers with missing ages are

```{r}
missing_rows <- 13:15
ti0 %>% slice(missing_rows)
```

Create mutliply imputed values for age. The default is to use every variable in the dataset other than age to impute the value of age. You don't want to use the name of the passenger, of course, so be sure to drop it before the imputation step.

```{r}
ti1 <- select(ti0, -name)
ti_mice <- mice(ti1)
```

The mice function creates a complex object. Go ahead and explore the various components, but be forewarned that this is messy. You can extract simple parts of the imputation with various functions. The complete function shows the complete datasets with the imputed values. Here are the first three rows where age was imputed the first time.

```{r}
ti_mice %>%
  complete(1) %>%
  slice(missing_rows)
```

Look at the imputations for the second, third, etc. times. Notice that the values change with each imputation.

```{r}
ti_mice %>%
  complete(2) %>%
  slice(missing_rows)
ti_mice %>%
  complete(3) %>%
  slice(missing_rows)
ti_mice %>%
  complete(4) %>%
  slice(missing_rows)
ti_mice %>%
  complete(5) %>%
  slice(missing_rows)

```

Use the with function of the mice package to fit a model to apply a particular analysis to each of the five imputed datasets.

```{r}
ti_with <- with(
  ti_mice, 
  glm(
    survived~pclass+rcs(age)+sex, 
    family=binomial)) 
```

Again, the object created here is complex. You can extract the individual analyses fairly easily. Here is the analysis of the first imputed dataset.

```{r}
ti_with$analyses[[1]]
```

The key variable here is sexmale, which shows how much different the log odds of survival are between men and women. 

Notice that the estimate for sexmale changes from one analysis to another, though not by much.

```{r}
ti_with$analyses[[2]]
ti_with$analyses[[3]]
ti_with$analyses[[4]]
ti_with$analyses[[5]]
```

Combine all these analyses with the pool function.

```{r}
ti_pool <- pool(ti_with)
summary(ti_pool)
log_or <- summary(ti_pool)[8, 2]
```

To complete things, compute the odds ratio and confidence interval.

```{r}
se <- summary(ti_pool)[8, 3]
or <- exp(log_or)
lo <- exp(log_or-1.96*se)
hi <- exp(log_or+1.96*se)
paste0(round(or, 3), " (", round(lo, 3), ",", round(hi, 3), ")")
```

