---
title: "Basics of cubic spline models"
author: "Steve Simon"
date: "2021-11-01"
categories:
- Recommendation
tags:
- Linear regression
output: html_document
---

```{r setup}
suppressMessages(suppressWarnings(library(broom)))
suppressMessages(suppressWarnings(library(dplyr)))
suppressMessages(suppressWarnings(library(knitr)))
suppressMessages(suppressWarnings(library(magrittr)))
suppressMessages(suppressWarnings(library(splines)))
suppressMessages(suppressWarnings(library(tidyr)))
```

### Artificial data

Suppose you have some data where you suspect the behavior differs for x=1 to 5, x=6 to 10, x=11 to 15, and x=16 to 20.

```{r}
library(ggplot2)
x <- 0:20
y <- rep(40, 21)
y[6:21] <- y[6:21]-3*(0:15)
y[11:21] <- y[11:21]+7*(0:10)
y[16:21] <- y[16:21]-(0:5)^2
y <- y+round(rnorm(21), 1)
simulated_example <- data.frame(x, y)
simulated_example
ggplot(simulated_example, aes(x, y)) +
  geom_point()
```

To make the graphs look nice, you need to include some intermediate values.

```{r}
x <- c(0:20, setdiff(seq(0, 20, by=1/64), 0:20))
```

You can get a variety of splines by defining constant, linear, quadratic, and cubic terms and then shift those functions to the right. After shifting, fill in the hole to the left with zeros.

```{r}
xm <- data.frame(
  c1 =rep(1, length(x)),
  c2 =x,
  c3 =x^2,
  c4 =x^3,
  c5 =(x> 5)*rep(1, length(x)),
  c6 =(x> 5)*(x- 5),
  c7 =(x> 5)*(x- 5)^2,
  c8 =(x> 5)*(x- 5)^3,
  c9 =(x>10)*rep(1, length(x)),
  c10=(x>10)*(x-10),
  c11=(x>10)*(x-10)^2,
  c12=(x>10)*(x-10)^3,
  c13=(x>15)*rep(1, length(x)),
  c14=(x>15)*(x-15),
  c15=(x>15)*(x-15)^2,
  c16=(x>15)*(x-15)^3,
  x=x,
  y=NA
)
xm$y[1:21] <- y
```


```{r}
display_curve <- function(dat, lb) {
  # Plot a line connecting the points in dat
  # Assume that column 1 is x and column 2 is y
  # Work with either a data frame or matrix
  dat %>%
    data.frame %>%
    select(1:2) %>%
    set_names(c("x", "y")) %>%
    ggplot(aes(x, y)) +
      ggtitle(lb) +
      geom_line() +
      xlab(" ") +
      ylab(" ")
}

display_dots <- function(cplot, dat) {
  # Add dots in dat to an existing graph
  # Assume that column 1 is x and column 2 is y
  # Work with either a data frame or matrix
  dat %>%
    data.frame %>%
    set_names(c("x", "y")) -> df
  cplot + geom_point(data=df, aes(x, y))
}

lb1 <- rep(c("Intercept", "Linear term", "Quadratic term", "Cubic term"), 4)
lb2 <- rep(c("for the full range", "restarted at x=5", "restarted at x=10", "restarted at x=15"), each=4)
lb <- paste(lb1, lb2)

for (j in 1:16) {
  dat <- xm[ , c("x",  paste0("c", j))]
  display_curve(dat, lb[j]) %>%
    display_dots(dat[1:21, ]) %>%
    plot
}

```

### Single cubic polynomial

This is the matrix of independent variables for a single cubic polynomial.

```{r}
kable(xm[1:21, 1:4])
```

The graph shown below represents the best fitting single cubic polynomial.

```{r}

lm(y~c2+c3+c4, data=xm) %>%
  augment %>%
  select(c2, .fitted) %>%
    display_curve("Single cubic fit") %>%
    display_dots(simulated_example)
```

### Separate cubic polynomials

So, we could fit a cubic model for the first five data points, for the second five, the third five, and the fourth five. This is a bit much: a cubic model has four parameters, so fitting four of them would use up 16 degrees of freedom in a data set with only 20 observations. But bear with me a bit on this.

The trick to fitting four separate cubic polynomials is to "restart" the cubic terms after x=5, x=10, and x=15.

```{r}
kable(xm[1:20, ])
```

```{r}
lm(y~c2+c3+c4+c5+c6+c7+c8+c9+c10+c11+c12+c13+c14+c15+c16, data=xm)  %>%
  augment %>%
  select(c2, .fitted) %>%
    display_curve("Discontinous cubic splines") %>%
    display_dots(simulated_example)
```

This function is not continuous or smooth. To make the function continuous, drop the extra intercept terms.

### Continuous splines

```{r}
kable(xm[1:20, c(1:4, 6:8, 10:12, 14:16)])
lm(y~c2+c3+c4+c6+c7+c8+c10+c11+c12+c14+c15+c16, data=xm)  %>%
  augment %>%
  select(c2, .fitted) %>%
    display_curve("Continuous but not smooth cubic splines") %>%
    display_dots(simulated_example)
```

While this graph is continuos, it still takes some abrupt term. The mathemSmoothness is measured in terms of the continuity of derivatives. 

### Smooth splines

Here is a function that has a continuous first derivative.

```{r}
kable(xm[1:20, c(1:4, 7:8, 11:12, 15:16)])
lm(y~c2+c3+c4+c7+c8+c11+c12+c15+c16, data=xm) %>%
  augment %>%
  select(c2, .fitted) %>%
    display_curve("Continuous and smooth (1st derivative) cubic splines") %>%
    display_dots(simulated_example)
```

Here is a function that has continuous first and second derivatives.

```{r}
kable(xm[1:20, c(1:4, 8, 12, 16)])
lm(y~c2+c3+c4+c8+c12+c16, data=xm) %>%
  augment %>%
  select(c2, .fitted) %>%
    display_curve("Continous and smooth (1st and 2nd derivatives) cubic splines") %>%
    display_dots(simulated_example)
```

This approach is simple and easy to follow, but there is one catch. There is an issue with multicollinearity.

```{r}
round(cor(xm[c(2:4, 8, 12, 16)]), 2)
```

The correlations are quite high and this can lead to computational problems, including rounding errors. So most spline models implemented on a computer use a different approach.

### B-splines

B-splines provide a solution with less issues of multi-collinearity. You use the bs function in the splines package to compute B-splines. 

```{r}
cubic_spline <- bs(xm$c2, knots=c(5, 10, 15), degree=3, intercept=TRUE)
kable(cubic_spline[1:21, ])
```

The individual columns represent piecwise cubic polynomials. Notice how they are concentrated in certain intervals.

```{r}
for (j in 1:dim(cubic_spline)[2]) {
  dat <- cbind(xm$c2, cubic_spline[ , j])
  display_curve(dat, "Cubic B-spline terms") %>%
    display_dots(dat[1:21, ]) %>%
    plot
}
```

B-splines have less issues with multicollinearity.

```{r}
round(cor(cubic_spline), 1)
```

Although there is some correlation, this not nearly as bad as the piecewise approach.

```{r}
lm(xm$y~cubic_spline) %>%
  bind_cols(xm$c2) %>%
  select(c2, .fitted) %>%
    display_curve("Cubic spline fit to the data") %>%
    display_dots(simulated_example)
```

#### Linear and quadratic B-splines

Although most applications use cubic B-splines, they are available in other forms. Here is the linear spline.

```{r}
linear_spline <- bs(xm$c2, knots=c(5, 10, 15), degree=1, intercept=TRUE)
kable(linear_spline[1:21, ])
```

The terms in the linear B-splines are mostly piecewise linear functions. Notice how they are zero outside certain ranges.

```{r}
for (j in 1:dim(linear_spline)[2]) {
  dat <- cbind(xm$c2, linear_spline[ , j])
  display_curve(dat, "Linear B-spline terms") %>%
    display_dots(dat[1:21, ]) %>%
    plot
}
```

```{r}
lm(xm$y~linear_spline) %>%
  augment %>%
  bind_cols(xm$c2) %>%
  select(c2, .fitted) %>%
    display_curve("Linear spline fit to the data") %>%
    display_dots(simulated_example)
```

```{r}
quadratic_spline <- bs(xm$c2, knots=c(5, 10, 15), degree=2, intercept=TRUE)
kable(quadratic_spline[1:21, ])
```

```{r}
for (j in 1:dim(quadratic_spline)[2]) {
  dat <- cbind(xm$c2, quadratic_spline[ , j])
  display_curve(dat, "Quadratic B-spline terms") %>%
    display_dots(dat[1:21, ]) %>%
    plot
}
```

```{r}
lm(xm$y~quadratic_spline) %>%
  bind_cols(xm$c2) %>%
  select(c2, .fitted) %>%
    display_curve("Quadratic spline fit to the data") %>%
    display_dots(simulated_example)
```

```{r}
cubic_spline <- bs(xm$c2, knots=c(5, 10, 15), degree=3, intercept=TRUE)
kable(cubic_spline[1:21, ])
```


```{r}
for (j in 1:dim(cubic_spline)[2]) {
  dat <- cbind(xm$c2, cubic_spline[ , j])
  display_curve(dat, "Cubic B-spline terms") %>%
    display_dots(dat[1:21, ]) %>%
    plot
}
```

```{r}
lm(xm$y~cubic_spline) %>%
  bind_cols(xm$c2) %>%
  select(c2, .fitted) %>%
    display_curve("Cubic spline fit to the data") %>%
    display_dots(simulated_example)
```


```{r}
natural_spline <- ns(xm$c2, knots=c(5, 10, 15), intercept=TRUE)
kable(natural_spline[1:21, ])
```


```{r}
extended_x <- seq(-5, 25, by=1/64)
extended_spline <- predict(natural_spline, extended_x)
for (j in 1:dim(natural_spline)[2]) {
  cbind(extended_x, extended_spline[ , j]) %>% 
    data.frame %>%
    display_matrix("Natural spline terms") %>%
    plot
}
```

```{r}
lm(xm$y~natural_spline) %>%
  display_fit("Natural splines")
```


References

Donald H. House. Chapter 14. Spline Curves. Available in [pdf format][hou1].

Aris Perperoglou, Willi Sauerbrei, Michal Abrahamowicz, Matthias Schmid. A review of spline function procedures in R. BMC Medical Research Methodology 19, 46 (2019). DOI: 10.1186/s12874-019-0666-3. Available in [html format][per1] or [pdf format][per2]. 

[hou1]: https://people.cs.clemson.edu/~dhouse/courses/405/notes/splines.pdf

[per1]: https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/s12874-019-0666-3
[per2]: https://bmcmedresmethodol.biomedcentral.com/track/pdf/10.1186/s12874-019-0666-3.pdf