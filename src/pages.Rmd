---
title: "Pages written in xxxx template"
source: new
date: "2023-01-10"
categories:
- Blog post
tags:
- Website details
output: html_document
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo=FALSE)
suppressMessages(suppressWarnings(library(glue)))
suppressMessages(suppressWarnings(library(magrittr)))
suppressMessages(suppressWarnings(library(readr)))
suppressMessages(suppressWarnings(library(stringr)))
```

```{r}
write_yaml <- function(page_year) {
  date_line <- paste0("date", ": 20", page_year, "-12-31")
  output_text <- glue('
  ---
  title: "Pages written in 20{page_year}"
  source: new
  {date_line}
  categories:
  - Blog post
  tags:
  - Website details
  output: html_document
  ---')
  return(output_text)
}
```

```{r}
write_links <- function(yr_list) {
  glue("[{yr}](http://new.pmean.com/{yr}/)") %>%
    paste(collapse=" | ")
}
```

```{r}
check_source <- function(file_text) {
  file_text %>%
    str_subset("^source\\: ") %>%
    str_remove(fixed("source: ")) %>%
    str_remove_all('"')  %>%
    str_remove_all("'") -> file_source
  
  if (length(file_source)==0) return("Error: no source")

  if (length(file_source)>1) return("Error: multiple sources")

  return(file_source)
}
```

```{r}
check_dates <- function(file_text) {
  file_text %>%
    str_subset(fixed("date: ")) %>%
    str_remove(fixed("date: ")) %>%
    str_remove_all('"') %>%
    str_remove_all("'")  -> file_date
  if (length(file_date)==0) return("Error: no date")
  if (length(file_date)==0) return("Error: multiple dates")
  return(file_date)
}
```

```{r}
write_list <- function(page_year) {
  # get file list
  list.files(path=glue("../text/{page_year}", pattern="*.md")) %>%
    str_subset("md$") -> f
  # open files and find information
  file_source <- NULL
  date_list <- NULL
  for (fn in f) {
    file_text <- read_lines(glue("../text/{page_year}/{fn}"))
    # get source
    file_source <- append(
      file_source,
      check_source(file_text))
    #get dates
    date_list <- append(
      date_list,
      check_dates(file_text))
  }
  # strip extensions
  f %>%
    str_replace(fixed(".Rmd"), "") %>%
    str_replace(fixed(".md"), "") -> f
  n <- length(f)
  o <- order(date_list, f)
  # create RMarkdown text
  header <- glue("New website ({n} files)")
  file_list <- glue(
    "+ {date_list[o]} ",
    "[{f[o]}]",
    "(http://new.pmean.com/{f[o]}/)  ") %>%
    paste(collapse="  \n")
  # search for problem files
  
  return(paste0(header, file_list))
}
```

```{r}
write_yaml(21)
```

`r write_list(21)`