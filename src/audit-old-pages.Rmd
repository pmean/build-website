---
title: "Check links on old pages"
author: "Steve Simon"
date: "Created 2024-06-25"
output: html_document
---
  
This program looks for key links in the old webpages

```{r setup}
suppressMessages(suppressWarnings(library(glue)))
suppressMessages(suppressWarnings(library(magrittr)))
suppressMessages(suppressWarnings(library(readr)))
suppressMessages(suppressWarnings(library(stringr)))
suppressMessages(suppressWarnings(library(tidyverse)))

path1 <- "c:/Users"
path2 <- str_subset(list.files(path1), "steve|simons")
path3 <- "Dropbox/professional/fun stuff/update-website"

"c:/Users/steve/Dropbox/professional/fun stuff/update-website"
"c:/Users/simons/Dropbox/professional/fun stuff/update-website"

html_path <- paste(path1, path2, path3, sep="/")
subdir_list=c(
  "00",
  "00files",
  "01",
  "02",
  "03",
  "04",
  "05",
  "06",
  "07",
  "08",
  "08a",
  "09",
  "10",
  "11",
  "12",
  "12a",
  "13",
  "14",
  "15",
  "16",
  "17",
  "18",
  "99",
  "archive",
  "category",
  "definitions",
  "weblog",
  "08/accrual",
  "08/definitions",
  "08/diagnostic",
  "08/faq",
  "08/images",
  "08/journal",
  "08/koans",
  "08/software",
  "08/training",
  "08/training/abstracts",
  "08/training/datasets",
  "08/training/exercises",
  "08/training/extras",
  "08/training/images",
  "08/website")
save_file <- "../data/check_old.RData"
```

### create html

```{r create}
html <- NULL
for (yr in rev(subdir_list)) {
  file_path <- paste(html_path, yr, sep="/")
  file_path %>%
    list.files(pattern="asp|htm$|html$") -> piper
  if (length(piper) == 0) next
  piper %>%
    str_remove("\\..*") -> fn
  piper %>%
    str_remove(".*\\.") -> ext
  data.frame(yr=yr, fn=fn, ext=ext) %>%
    bind_rows(html) -> html
}
n <- nrow(html)
```


### Search for links to old files

```{r links}
search_link <- function(tx) {
  prefix1 <- '<p>This page is moving to a <a href="'
  prefix2 <- '<p>This page has moved to a <a href="'
  postfix <- '">new website</a>.</p>'
  prepost <- paste(prefix1, prefix2, postfix, sep="|")
  website <- "http://new.pmean.com/"
  slash   <- "/"
  tx %>%
    str_subset(postfix) %>%
    str_replace(prefix1, "") %>%
    str_replace(prefix2, "") %>%
    str_replace(postfix, "") %>%
    str_replace(website, "") %>%
    str_replace(slash,   "") %>%
    str_remove_all("\\s") %>%
    str_trim %>%
    paste0("") -> piper
  piper %>%
    paste0(collapse=", ")
}
```

### Search for size

```{r size}
search_size <- function(tx) {
  ty <- str_remove_all(tx, "\\s")
  length(tx)-sum(ty == "")
}
```

### Read file text

```{r read}
# The str_trim function is not working. There
#  may be an encoding problem. See
#   "about_encoding" in the stringi package
#   https://search.r-project.org/CRAN/refmans/
#     stringi/html/about_encoding.html
#
# Help may come from the "stri_enc_toutf8" function 
#   https://search.r-project.org/CRAN/refmans/
#     stringi/html/stri_enc_toutf8.html
# A simpler solution may be
#   str_remove_all("\\s")
full_name <-
  paste0(
  html_path, "/",
  html$yr, "/",
  html$fn, ".",
  html$ext)
html$size <- -1
html$link <- "999"
for (i in 1:n) {
  tx <- read_lines(full_name[i])
  html$link[i] <- search_link(tx)
  html$size[i] <- search_size(tx)
}
html$miss <- as.numeric(nchar(html$link) == 0)
html$stub <- as.numeric(html$size <= 10)
html <- arrange(html, yr, fn)
save(html, file=save_file)
```

### Simple statistics

```{r simple}
summary(html$size)
count(html, ext)
count(html, miss)
count(html, stub)
```
